<!DOCTYPE html>
<html lang="en">
<head>
    const messagesDiv = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const chatHistoryKey = 'lastChat'; // store only last chat

    // Load last chat from localStorage
    let chatHistory = JSON.parse(localStorage.getItem(chatHistoryKey)) || [];

    function convertMarkdownToHtml(markdownText) {
        let html = markdownText
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
        html = html.replace(/\n/g, '<br/>');
        return html;
    }

    function addMessage(text, className, useInnerHTML = false) {
        const msgElement = document.createElement('div');
        msgElement.classList.add(className);

        if (useInnerHTML) {
            msgElement.innerHTML = text;
        } else {
            msgElement.textContent = text;
        }
        messagesDiv.appendChild(msgElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function displayChatHistory() {
        messagesDiv.innerHTML = ''; // Clear messages
        chatHistory.forEach(message => {
            if (message.className === 'bot-message') {
                addMessage(convertMarkdownToHtml(message.text), message.className, true);
            } else {
                addMessage(message.text, message.className, false);
            }
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    displayChatHistory();

    async function sendMessage() {
        const message = userInput.value.trim();
        if (!message) return;

        addMessage(message, 'user-message');
        chatHistory.push({ text: message, className: 'user-message' });
        userInput.value = '';

        try {
            const response = await fetch('https://gemini-chatbot-proxy-653233019960.europe-west1.run.app/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP error! Status: ${response.status}, Details: ${errorText}`);
            }

            const data = await response.json();
            const rawBotReply = data.reply;

            const formattedBotReply = convertMarkdownToHtml(rawBotReply);
            addMessage(formattedBotReply, 'bot-message', true);

            chatHistory.push({ text: rawBotReply, className: 'bot-message' });

            // Save only the last chat (current conversation)
            localStorage.setItem(chatHistoryKey, JSON.stringify(chatHistory));

        } catch (error) {
            console.error('Error sending message:', error);
            addMessage('Error: Could not get a response from the assistant. Please try again.', 'bot-message');
        }
    }
</script>
